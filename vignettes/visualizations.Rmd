---
title: 'Visualization of clustifyR results'
date: '`r Sys.Date()`'
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    vignette: >
      %\VignetteIndexEntry{clustifyR-viz}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
---

```{r knitr_opts, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center"
)
```

The direct output of `clustify` is a matrix of correlation coefficients. And for `clustify_lists` and `clustify_nudge`, positive scores. Built-in functions are available to visualize this results.

## TSNE/UMAP

```{r, warning = F, message = F}
library(clustifyR)
library(here)
full_pbmc4k_matrix <- clustifyrdata::pbmc4k_matrix
full_pbmc4k_meta <- clustifyrdata::pbmc4k_meta

# clustify
res <- clustify(
  input = full_pbmc4k_matrix,
  metadata = full_pbmc4k_meta,
  cluster_col = "cluster",
  ref_mat = cbmc_ref,
  query_genes = pbmc4k_vargenes
)

# plot_cor generates a plot per reference cluster
g <- plot_cor(
  res,
  full_pbmc4k_meta,
  cluster_col = "cluster",
  x = "tSNE_1", 
  y = "tSNE_2"
)

length(g) == ncol(cbmc_ref)

g[[1]]

# plot_best_call to view called identities in one plot
plot_best_call(
  res,
  full_pbmc4k_meta,
  do.label = T
)

# intentionally overcluster and clustify to assess idents
# in this case, overclustered local averages agree with cluster clustify results
overcluster_test(
  full_pbmc4k_matrix,
  full_pbmc4k_meta,
  cbmc_ref,
  cluster_col = "cluster",
  n = 5
  )

# `clustify` against reference combinations also informs clustering
# in this case, several clusters seems to be a mixture with neighboring idents
comb_ref <- make_comb_ref(cbmc_ref)
res2 <- clustify(
  input = full_pbmc4k_matrix,
  metadata = full_pbmc4k_meta,
  cluster_col = "cluster",
  ref_mat = comb_ref,
  query_genes = pbmc4k_vargenes
)
plot_best_call(
  res2,
  full_pbmc4k_meta,
  do.label = T
)
```

## Heatmap
```{r, warning = F, message = F}
res <- clustify(
  input = full_pbmc4k_matrix,
  metadata = full_pbmc4k_meta,
  cluster_col = "cluster",
  ref_mat = cbmc_ref
)

plot_cor_heatmap(res)

res2 <- clustify_lists(
  input = full_pbmc4k_matrix,
  cluster_info = full_pbmc4k_meta,
  cluster_col = "cluster",
  marker = pbmc4k_markers,
  marker_inmatrix = F
)

plot_cor_heatmap(res2)
```

## GSEA top hits per cluster
Using the gsea method implemented, we can also convert reactome/GO/pathway gene lists into forms that can be scored and plotted.
```{r, warning = F, message = F}
# gene lists can be converted from gmt files (Broad)
list_reactome <- gmt_to_list(here("c2.cp.reactome.v6.2.symbols.gmt"))

full_pbmc4k_avg <- average_clusters(
  full_pbmc4k_matrix, 
  full_pbmc4k_meta, 
  cluster_col = "classified"
)

res <- plot_pathway_gsea(
  full_pbmc4k_avg[,1:2], 
  list_reactome, 
  topn = 3)

# returns dataframe of gsea analysis
res[[1]][1:2,1:2]
# and plot
res[[2]]
```

## other attributes in the metadata
Visualization of other attributes shared in the metadata between ref and query by `plot_cols`, such as nGene, nUMI, mt_percentage, as another way of identity confirmation after `clustify`. Certain cell types have distinct patterns, more genes detected, for example.
